# Supabase Backend Integration Guide

## Overview

Supabase provides everything you need for Charter Legacy's backend:

- âœ… **Magic Link Authentication** (built-in, no coding needed)
- âœ… **PostgreSQL Database** (for users, LLCs, wills, documents)
- âœ… **Auto-generated REST API** (based on your database schema)
- âœ… **Real-time subscriptions** (for Legacy Timer updates)
- âœ… **Storage** (for document vault)

---

## Step 1: Create Supabase Project

1. Go to https://supabase.com
2. Sign up (free tier available)
3. Click "New Project"
   - **Name:** charter-legacy
   - **Database Password:** [save this securely]
   - **Region:** Choose closest to your users
4. Wait ~2 minutes for project creation

---

## Step 2: Enable Magic Link Authentication

1. In Supabase Dashboard â†’ **Authentication** â†’ **Providers**
2. Enable **Email** provider
3. **Disable** password authentication (we only want Magic Link)
4. Configure email templates:
   - **Magic Link:** Customize with Charter Legacy branding
   - **From:** `noreply@charterlegacy.com` (configure your domain)

5. **Email Settings** â†’ Add your domain:
   - **Site URL:** `https://app.charterlegacy.com`
   - **Redirect URLs:** Add `https://app.charterlegacy.com/*`

---

## Step 3: Create Database Schema

In Supabase Dashboard â†’ **SQL Editor** â†’ Run this:

\`\`\`sql
-- Users table (auto-created by Supabase Auth)
-- We'll extend it with a profile table

-- User profiles
CREATE TABLE profiles (
id UUID REFERENCES auth.users(id) PRIMARY KEY,
first_name TEXT,
last_name TEXT,
user_type TEXT CHECK (user_type IN ('llc', 'will')),
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- LLCs table
CREATE TABLE llcs (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
user_id UUID REFERENCES auth.users(id) NOT NULL,
product_type TEXT, -- 'founders_shield', 'medical_pllc', 'trade_professional'
llc_name TEXT NOT NULL,
llc_status TEXT DEFAULT 'active',
privacy_shield_active BOOLEAN DEFAULT true,
next_deadline DATE,
deadline_type TEXT,
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Wills table
CREATE TABLE wills (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
user_id UUID REFERENCES auth.users(id) NOT NULL,
will_status TEXT DEFAULT 'executed',
executed_date DATE,
legacy_timer_active BOOLEAN DEFAULT true,
last_checkin TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
successor_count INTEGER DEFAULT 0,
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable Row Level Security (RLS)
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE llcs ENABLE ROW LEVEL SECURITY;
ALTER TABLE wills ENABLE ROW LEVEL SECURITY;

-- Policies: Users can only read their own data
CREATE POLICY "Users can view own profile"
ON profiles FOR SELECT
USING (auth.uid() = id);

CREATE POLICY "Users can view own LLCs"
ON llcs FOR SELECT
USING (auth.uid() = user_id);

CREATE POLICY "Users can view own wills"
ON wills FOR SELECT
USING (auth.uid() = user_id);

-- Function to create profile on signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS \$\$
BEGIN
INSERT INTO public.profiles (id, first_name, last_name)
VALUES (new.id, '', '');
RETURN new;
END;
\$\$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger to auto-create profile
CREATE TRIGGER on_auth_user_created
AFTER INSERT ON auth.users
FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
\`\`\`

---

## Step 4: Get Your API Keys

1. In Supabase Dashboard â†’ **Settings** â†’ **API**
2. Copy these values:
   - **Project URL:** `https://[your-project].supabase.co`
   - **anon/public key:** (safe to use in frontend)

---

## Step 5: Update Frontend JavaScript Files

See updated files:

- \`app/scripts/auth.js\` - Magic Link authentication
- \`app/scripts/dashboard.js\` - Dashboard data loading
- \`app/config.js\` - Supabase configuration (NEW)

---

## Step 6: Test Locally

1. Update \`app/config.js\` with your Supabase URL and key
2. Open \`app/auth.html\` in browser
3. Enter your email
4. Check email for magic link
5. Click link â†’ should redirect to dashboard

---

## Step 7: Insert Test Data

For testing, add sample data:

\`\`\`sql
-- Insert test profile (use your auth user ID)
INSERT INTO profiles (id, first_name, last_name, user_type)
VALUES ('[your-user-id]', 'John', 'Doe', 'llc');

-- Insert test LLC
INSERT INTO llcs (user_id, product_type, llc_name, next_deadline, deadline_type)
VALUES ('[your-user-id]', 'founders_shield', 'My Test LLC', '2026-05-01', 'Annual Report');

-- OR insert test Will
INSERT INTO wills (user_id, executed_date, successor_count)
VALUES ('[your-user-id]', '2026-01-20', 2);
\`\`\`

---

## API Endpoints (Auto-Generated by Supabase)

\`\`\`javascript
// Get user profile
GET https://[your-project].supabase.co/rest/v1/profiles?id=eq.[user-id]
Headers: { apikey: [anon-key], Authorization: Bearer [session-token] }

// Get user's LLCs
GET https://[your-project].supabase.co/rest/v1/llcs?user_id=eq.[user-id]

// Get user's wills
GET https://[your-project].supabase.co/rest/v1/wills?user_id=eq.[user-id]
\`\`\`

---

## Next Steps

1. âœ… Create Supabase project
2. âœ… Enable Magic Link auth
3. âœ… Run database schema SQL
4. âœ… Get API keys
5. âœ… Update \`app/config.js\` with your keys
6. ðŸ”„ Test authentication flow
7. ðŸ”„ Test dashboard data loading
8. ðŸ”„ Deploy to production

---

## Cost

- **Free tier:** 500MB database, 50,000 monthly active users, 1GB file storage
- **Pro tier ($25/mo):** 8GB database, 100,000 MAU, 100GB storage
- Start free, upgrade when needed

---

## Security Notes

- âœ… Row Level Security (RLS) enabled - users can only access their own data
- âœ… API keys are safe to use in frontend (anon key has limited permissions)
- âœ… Session tokens expire automatically
- âœ… Magic Links expire after 1 hour
