<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Sovereign Intent - Charter Legacy</title>
    <link rel="stylesheet" href="../styles/app.css">
    <link rel="stylesheet" href="../styles/wizard-premium.css">
    <link rel="stylesheet" href="../styles/wizard-layout.css">
<style>
/* Advanced Options Accordion */
.advanced-options-accordion {
    margin-top: var(--spacing-lg);
    border: 1px solid rgba(212, 175, 55, 0.2);
    border-radius: var(--radius-sm);
    background: rgba(255, 255, 255, 0.02);
    overflow: hidden;
    transition: all 0.3s ease;
}

.accordion-trigger {
    width: 100%;
    padding: var(--spacing-md) var(--spacing-lg);
    background: transparent;
    border: none;
    color: var(--text-primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    font-weight: 600;
}

.trigger-label {
    display: flex;
    align-items: center;
    gap: 12px;
}

.trigger-icon {
    width: 20px;
    height: 20px;
    color: var(--gold-leaf);
}

.chevron-icon {
    width: 18px;
    height: 18px;
    transition: transform 0.3s ease;
}

.advanced-options-accordion.open .chevron-icon {
    transform: rotate(180deg);
}

.accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 0 var(--spacing-lg);
}

.advanced-options-accordion.open .accordion-content {
    max-height: 2000px; /* Increased to accommodate full 6-manager slate */
    padding-bottom: var(--spacing-lg);
}

.wizard-step {
    padding-bottom: 100px; /* Breathe room for buttons at the bottom */
}

.advanced-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-md);
    margin-top: var(--spacing-md);
}

.bank-ready-card {
    border-color: var(--gold-leaf);
    background: rgba(212, 175, 55, 0.05);
}

.card-badge.primary {
    background: var(--gold-leaf);
    color: black;
}

.card-subtext {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-top: -8px;
    margin-bottom: var(--spacing-md);
}

.btn-outline-gold {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: transparent;
    border: 1px solid var(--gold-leaf);
    color: var(--gold-leaf);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    margin-top: var(--spacing-sm);
    transition: all 0.2s;
}

.btn-outline-gold:hover {
    background: rgba(212, 175, 55, 0.1);
}

.empty-state {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin: var(--spacing-sm) 0;
}
/* Tooltip Styling */
.help-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    background: rgba(212, 175, 55, 0.1);
    color: var(--gold-leaf);
    border-radius: 50%;
    font-size: 11px;
    font-weight: 800;
    cursor: help;
    margin-left: 6px;
    transition: all 0.2s;
    vertical-align: middle;
}

.help-icon:hover {
    background: var(--gold-leaf);
    color: black;
}

[data-tooltip] {
    position: relative;
}

[data-tooltip]::before {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%) translateY(10px);
    padding: 8px 12px;
    background: var(--obsidian-ink);
    color: white;
    font-size: 0.75rem;
    border-radius: 8px;
    white-space: normal;
    width: 200px;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow-md);
    pointer-events: none;
    line-height: 1.4;
    text-align: center;
}

[data-tooltip]:hover::before {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
}
</style>
<body class="wizard-page">
    <nav class="dashboard-nav">
        <div class="nav-branding">
            <a href="/app/" class="nav-logo">
                <svg class="logo" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M24 4L40 14V34L24 44L8 34V14L24 4Z" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M24 16L32 21V31L24 36L16 31V21L24 16Z" fill="currentColor"/>
                </svg>
            </a>
            <div class="nav-title-group">
                <span class="nav-app-name">Charter Legacy</span>
                <span class="nav-dashboard-label">Formation Wizard</span>
            </div>
        </div>
        <div class="nav-status">Phase: Statutory Identification</div>
    </nav>

    <main class="wizard-main">
        <div class="wizard-container">
            <!-- Multi-Step Progress Indicator -->
            <div class="wizard-progress">
                <div class="progress-step active" data-step="1">
                    <div class="step-circle">
                        <svg class="step-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2L20 7V17L12 22L4 17V7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                            <circle cx="12" cy="12" r="3" fill="currentColor"/>
                        </svg>
                    </div>
                    <span class="step-label">Identity</span>
                </div>
                <div class="progress-connector"></div>
                <div class="progress-step" data-step="2">
                    <div class="step-circle">
                        <svg class="step-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </div>
                    <span class="step-label">Address</span>
                </div>
                <div class="progress-connector"></div>
                <div class="progress-step" data-step="3">
                    <div class="step-circle">
                        <svg class="step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                    </div>
                    <span class="step-label">Review</span>
                </div>
                <div class="progress-connector"></div>
                <div class="progress-step" data-step="4">
                    <div class="step-circle">
                        <svg class="step-icon" viewBox="0 0 24 24" fill="none">
                            <rect x="1" y="4" width="22" height="16" rx="2" stroke="currentColor" stroke-width="2"/>
                            <line x1="1" y1="10" x2="23" y2="10" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </div>
                    <span class="step-label">Payment</span>
                </div>
                <div class="progress-connector"></div>
                <div class="progress-step" data-step="5">
                    <div class="step-circle">
                        <svg class="step-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </div>
                    <span class="step-label">Success</span>
                </div>
            </div>

            <form id="intentForm" class="intent-form">
                <!-- Step 1: Branding -->
                <section class="wizard-step" id="step1">
                    <div class="wizard-header">
                        <svg class="wizard-logo" viewBox="0 0 48 48" fill="none">
                            <path d="M24 4L40 14V34L24 44L8 34V14L24 4Z" stroke="currentColor" stroke-width="2"/>
                            <path d="M24 16L32 21V31L24 36L16 31V21L24 16Z" fill="currentColor"/>
                        </svg>
                        <span class="wizard-phase">Formation Wizard</span>
                    </div>
                    
                    <h2 class="step-title">Sovereign Identity</h2>
                    <p class="step-description">The name of your LLC must be unique in Florida.</p>
                    
                    <div class="form-field">
                        <label for="llcName">Desired LLC Name<span class="required">*</span>
                            <span class="help-icon" data-tooltip="Must be unique in Florida. 65% of our users add terms like 'Investments' or 'Holdings' to differentiate their names from existing entities.">?</span>
                        </label>
                        <div class="input-with-icon">
                            <svg class="input-icon" viewBox="0 0 24 24" fill="none">
                                <path d="M12 2L20 7V17L12 22L4 17V7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                                <circle cx="12" cy="12" r="3" fill="currentColor"/>
                            </svg>
                            <input type="text" id="llcName" name="llcName" placeholder="Charter Legacy LLC" required oninput="validateLLCName(this)">
                        </div>
                        <span class="input-hint">Must include "LLC" or "Limited Liability Company"</span>
                    </div>

                    <div class="form-field">
                        <label for="purpose">Business Purpose (Optional)
                            <span class="help-icon" data-tooltip="Describes your business activity. 'Any and all lawful business' is used by 82% of Florida LLC filings.">?</span>
                        </label>
                        <div class="input-with-icon" style="position: relative;">
                            <svg class="input-icon" viewBox="0 0 24 24" fill="none">
                                <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2Z" stroke="currentColor" stroke-width="2"/>
                                <path d="M14 2V8H20" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <textarea id="purpose" name="purpose" placeholder="Real Estate Investment, Consulting, etc." maxlength="240" oninput="updateCharCounter(this)">Any legal business purpose.</textarea>
                            <span class="char-counter" id="purposeCounter">0 / 240</span>
                        </div>
                    </div>

                    <!-- Enhanced Statutory Enhancements Card -->
                    <div class="enhancements-card">
                        <div class="card-header">
                            <svg class="card-icon" viewBox="0 0 24 24" fill="none">
                                <path d="M12 2L20 7V17L12 22L4 17V7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                                <path d="M12 8L15 10V14L12 16L9 14V10L12 8Z" fill="currentColor"/>
                            </svg>
                            <h3>Official Florida Certificates
                                <span class="help-icon" data-tooltip="Official documents from the Secretary of State that prove your LLC's active status and formation details.">?</span>
                            </h3>
                            <span class="card-badge">Optional</span>
                        </div>
                        
                        <div class="enhancement-option">
                            <input type="checkbox" id="certStatus" name="certStatus" value="5.00" onchange="updateTotal()">
                            <label for="certStatus">
                                <div class="option-content">
                                    <span class="option-title">Certificate of Status</span>
                                    <span class="option-description">Official state verification document</span>
                                </div>
                                <span class="option-price">+$5.00</span>
                            </label>
                        </div>
                        
                        <div class="enhancement-option">
                            <input type="checkbox" id="certCopy" name="certCopy" value="30.00" onchange="updateTotal()">
                            <label for="certCopy">
                                <div class="option-content">
                                    <span class="option-title">Certified Copy of Articles</span>
                                    <span class="option-description">State-certified formation documents</span>
                                </div>
                                <span class="option-price">+$30.00</span>
                            </label>
                        </div>
                    </div>

                    <!-- Authorized Person #1 (Standard Flow) -->
                    <div class="enhancements-card bank-ready-card">
                        <div class="card-header">
                            <svg class="card-icon" viewBox="0 0 24 24" fill="none">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2"/>
                                <circle cx="8.5" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
                                <line x1="20" y1="8" x2="20" y2="14" stroke="currentColor" stroke-width="2"/>
                                <line x1="23" y1="11" x2="17" y2="11" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <h3>Main Partner or Manager
                                <span class="help-icon" data-tooltip="Authorized persons listed here will be authorized to open bank accounts and sign contracts for the LLC.">?</span>
                            </h3>
                            <span class="card-badge primary">Bank Required</span>
                        </div>
                        <p class="card-subtext">This is the person authorized to open bank accounts and sign contracts.</p>
                        
                        <div class="input-row">
                            <div class="form-field">
                                <label for="mgr1_first">First Name</label>
                                <input type="text" id="mgr1_first" name="mgr1_first" placeholder="John" onchange="collectEntityData()" onblur="this.value = normalizeName(this.value)">
                            </div>
                            <div class="form-field">
                                <label for="mgr1_last">Last Name</label>
                                <input type="text" id="mgr1_last" name="mgr1_last" placeholder="Doe" onchange="collectEntityData()" onblur="this.value = normalizeName(this.value)">
                            </div>
                        </div>
                        
                        <div class="form-field">
                            <label for="mgr1_addr">Street Address</label>
                            <input type="text" id="mgr1_addr" name="mgr1_addr" placeholder="123 Innovation Way" onchange="collectEntityData()">
                        </div>
                    </div>

                    <!-- Expert Mode: Advanced Filing Options -->
                    <div class="advanced-options-accordion">
                        <button type="button" class="accordion-trigger" onclick="toggleAdvanced(this)">
                            <div class="trigger-label">
                                <svg class="trigger-icon" viewBox="0 0 24 24" fill="none">
                                    <path d="M12 15V3m0 12l-4-4m4 4l4-4M2 17l.621 2.485A2 2 0 0 0 4.561 21h14.878a2 2 0 0 0 1.94-1.515L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>Advanced Filing Options</span>
                            </div>
                            <svg class="chevron-icon" viewBox="0 0 24 24" fill="none">
                                <polyline points="6 9 12 15 18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        
                        <div class="accordion-content">
                            <div class="advanced-grid">
                                <!-- Effective Date -->
                                <div class="form-field">
                                    <label for="effectiveDate">Future Effective Date</label>
                                    <input type="date" id="effectiveDate" name="effectiveDate" onchange="collectEntityData()">
                                    <span class="input-hint">Specify a date up to 90 days in the future (optional)</span>
                                </div>
                                
                            </div>
                            
                            <div class="additional-managers">
                                <h4>Additional Company Leaders</h4>
                                <div id="managersList" class="managers-grid">
                                    <!-- Dynamic Manager Slots 2-6 would go here or be toggled -->
                                    <p class="empty-state">No other partners added yet. You've already listed the first person (above).</p>
                                    <button type="button" class="btn-outline-gold" onclick="addManagerSlot()">
                                        <svg viewBox="0 0 24 24" fill="none" width="16" height="16">
                                            <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2"/><line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2"/>
                                        </svg>
                                        Add Member/Manager
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-actions">
                        <button type="button" class="btn-wizard-primary" onclick="nextStep(2)">
                            <span>Continue to Address</span>
                            <svg class="btn-arrow" viewBox="0 0 24 24" fill="none">
                                <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </section>

                <!-- Step 2: Physicality -->
                <section class="wizard-step" id="step2" style="display: none;">
                    <h2 class="step-title">Address of Record</h2>
                    <p class="step-description">Your principal physical address in Florida.</p>
                    
                    <div class="input-group">
                        <label for="address">Street Address</label>
                        <input type="text" id="address" name="address" placeholder="123 Innovation Way" required>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label for="city">City</label>
                            <input type="text" id="city" name="city" placeholder="DeLand" required>
                        </div>
                        <div class="input-group">
                            <label for="zip">Zip Code</label>
                            <input type="text" id="zip" name="zip" placeholder="32720" required maxlength="5" pattern="[0-9]*" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, ''); collectEntityData()">
                        </div>
                    </div>

                    <div class="wizard-actions">
                        <button type="button" class="btn-secondary" onclick="prevStep(1)">Back</button>
                        <button type="button" class="btn-wizard-primary" onclick="nextStep(3)">
                            <span>Continue to Payment</span>
                            <svg class="btn-arrow" viewBox="0 0 24 24" fill="none">
                                <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </section>

                <!-- Step 3: Review & Statutory Audit -->
                <section class="wizard-step" id="step3" style="display: none;">
                    <div class="success-celebration" style="margin-bottom: var(--spacing-md);">
                        <div class="audit-badge audit-ready" id="auditStatusBadge">
                            <span>Ready for Filing</span>
                        </div>
                        <h2 class="step-title" style="margin-top: 10px;">Review & Audit</h2>
                        <p class="step-description">Our AI is auditing your data for Florida statutory compliance.</p>
                    </div>

                    <div class="review-grid" id="auditReport">
                        <!-- Dynamic Audit Content will be injected here -->
                    </div>

                    <div class="wizard-actions dual-actions">
                        <button type="button" class="btn-wizard-primary" onclick="nextStep(4)">
                            Confirm & Continue to Payment
                        </button>
                        <button type="button" class="btn-secondary" onclick="prevStep(2)">
                            Back
                        </button>
                    </div>
                </section>

                <!-- Step 4: Payment (Mock) -->
                <section class="wizard-step" id="step4" style="display: none;">
                    <h2 class="step-title">Secure Fee Payment</h2>
                    <p class="step-description">State filing fee plus Charter Legacy processing.</p>
                    
                    <div class="payment-summary">
                        <div class="summary-line">
                            <span>Florida Filing Fee</span>
                            <span>$125.00</span>
                        </div>
                        <div id="optionalExtras">
                            <!-- Dynamic Add-ons here -->
                        </div>
                        <div class="summary-line">
                            <span>Charter Processing</span>
                            <span>$74.00</span>
                        </div>
                        <div class="summary-total">
                            <span>Total</span>
                            <span id="finalTotal">$199.00</span>
                        </div>
                    </div>

                    <div class="card-element">
                        <div id="card-mock">
                            <input type="text" placeholder="Card Number" style="width: 100%;">
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <input type="text" placeholder="MM/YY" style="width: 60%">
                                <input type="text" placeholder="CVC" style="width: 40%">
                            </div>
                        </div>
                    </div>

                    <div class="wizard-actions dual-actions">
                        <button type="button" class="btn-wizard-primary" id="confirmPayBtn" onclick="nextStep(5)">
                            Confirm & Pay
                        </button>
                        <button type="button" class="btn-secondary" onclick="prevStep(3)">
                            Back
                        </button>
                    </div>
                </section>

                <!-- Step 5: Operating Agreement Prompt -->
                <section class="wizard-step" id="step5" style="display: none;">
                    <div class="success-celebration">
                        <div class="success-glyph">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M12 2L20 7V17L12 22L4 17V7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                                <polyline points="9 11 12 14 16 9" stroke="var(--gold-leaf)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <h2 class="step-title">Formation Complete</h2>
                        <p class="step-description">Your LLC is being filed with the State of Florida.</p>
                    </div>
                    
                    <div class="oa-prompt-card">
                        <div class="oa-card-header">
                            <div class="oa-icon">ðŸ“‹</div>
                            <h3>Draft Your Operating Agreement</h3>
                            <p>Establish governance rules and protect your limited liability status.</p>
                        </div>
                        
                        <div class="oa-benefits">
                            <h4 class="benefits-label">Why You Need This</h4>
                            <ul class="benefits-list">
                                <li>
                                    <span class="check-icon">âœ“</span>
                                    <span>Defines member rights and responsibilities</span>
                                </li>
                                <li>
                                    <span class="check-icon">âœ“</span>
                                    <span>Establishes management structure</span>
                                </li>
                                <li>
                                    <span class="check-icon">âœ“</span>
                                    <span>Protects limited liability status</span>
                                </li>
                                <li>
                                    <span class="check-icon">âœ“</span>
                                    <span>Required by most banks for business accounts</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="wizard-actions dual-actions">
                        <button type="button" class="btn-wizard-primary" onclick="draftOANow()">
                            Draft Now (5 minutes)
                        </button>
                        <button type="button" class="btn-secondary" onclick="skipOAForNow()">
                            Skip for Now
                        </button>
                    </div>
                </section>
            </form>
        </div>
    </main>

    <script src="../core/config.js"></script>
    <script>
        let currentStep = 1;
        let selectedAction = 'formation';
        let currentEntityId = null;
        const urlParams = new URLSearchParams(window.location.search);
        
        // Institutional Handshake: Parse Intent
        const intentEntity = urlParams.get('entity');
        const intentAction = urlParams.get('action');

        if (intentEntity) {
            document.getElementById('llcName').value = intentEntity;
            document.getElementById('llcName').readOnly = true;
        }

        if (intentAction === 'correction') {
            window.location.href = `/app/maintenance-wizard.html${window.location.search}`;
        }

        // Initialize Character Counters
        window.addEventListener('load', () => {
            updateCharCounter(document.getElementById('purpose'));
            updateTotal();
        });

        if (intentAction) {
            selectedAction = intentAction;
            // Tailor the UI for the action
            if (intentAction === 'annual_report' || intentAction === 'annual_report_bundle') {
                document.querySelector('.step-title').textContent = 'Confirm Institutional Identity';
                document.querySelector('.step-description').textContent = 'Verify the entity for the annual statutory pulse.';
            }
        }

        const BASE_FEE = intentAction === 'annual_report' || intentAction === 'annual_report_bundle' ? 138.75 : 199.00;

        function updateTotal() {
            const certStatus = document.getElementById('certStatus').checked ? 5.00 : 0;
            const certCopy = document.getElementById('certCopy').checked ? 30.00 : 0;
            
            // Bundle Logic: If Annual Report Bundle, RA/Amendment changes are $0 extra
            let total = BASE_FEE + certStatus + certCopy;
            
            document.getElementById('finalTotal').textContent = `$${total.toFixed(2)}`;
            
            // Update Summary UI
            let addOnHtml = '';
            if (selectedAction === 'annual_report_bundle') {
                addOnHtml += `<div class="summary-line" style="color: var(--accent-green); font-weight: 700;"><span>Sovereign Bundle</span><span>Included</span></div>`;
            }
            if (certStatus) addOnHtml += `<div class="summary-line"><span>Certificate of Status</span><span>$5.00</span></div>`;
            if (certCopy) addOnHtml += `<div class="summary-line"><span>Certified Copy</span><span>$30.00</span></div>`;
            document.getElementById('optionalExtras').innerHTML = addOnHtml;
        }

        function showValidationError(message) {
            const toast = document.createElement('div');
            toast.className = 'validation-toast';
            toast.innerHTML = `
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function validateStep(step) {
            // Remove previous error highlights
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
            
            if (step === 1) {
                const name = document.getElementById('llcName').value.trim();
                const m1f = document.getElementById('mgr1_first').value.trim();
                const m1l = document.getElementById('mgr1_last').value.trim();
                const m1a = document.getElementById('mgr1_addr').value.trim();

                if (!name) {
                    document.getElementById('llcName').classList.add('input-error');
                    showValidationError('Desired LLC Name is required.');
                    return false;
                }
                if (!name.toUpperCase().includes('LLC') && !name.toUpperCase().includes('LIMITED LIABILITY COMPANY')) {
                    document.getElementById('llcName').classList.add('input-error');
                    showValidationError('LLC Name must include "LLC" or "Limited Liability Company".');
                    return false;
                }
                if (!m1f || !m1l || !m1a) {
                    showValidationError('Please complete the primary partner information.');
                    return false;
                }
            }

            if (step === 2) {
                const address = document.getElementById('address').value.trim();
                const city = document.getElementById('city').value.trim();
                const zip = document.getElementById('zip').value.trim();

                if (!address || !city || !zip) {
                    showValidationError('Principal Place of Business address is mandatory.');
                    return false;
                }

                if (address.toLowerCase().includes('p.o. box') || address.toLowerCase().includes('po box')) {
                    document.getElementById('address').classList.add('input-error');
                    showValidationError('Statutory Block: Â§ 605.0113 prohibits P.O. Boxes for the Principal Place of Business.');
                    return false;
                }
            }

            return true;
        }

        function nextStep(step) {
            // Validate the CURRENT step before moving to the NEXT step
            const fromStep = currentStep;
            if (step > fromStep) {
                if (!validateStep(fromStep)) return;
                
                // Extra gating for Review-to-Payment (Step 3 -> Step 4)
                if (fromStep === 3) {
                    const data = collectEntityData();
                    if (data.principal_address.toLowerCase().includes('p.o. box') || data.principal_address.toLowerCase().includes('po box')) {
                        showValidationError('Statutory Block: You must provide a physical address before proceeding to payment.');
                        return;
                    }
                    if (!data.llc_name.toUpperCase().includes('LLC') && !data.llc_name.toUpperCase().includes('LIMITED LIABILITY COMPANY')) {
                        showValidationError('Filing Block: LLC Name must be corrected before payment.');
                        return;
                    }
                }
            }

            // Trigger Audit if moving to review step
            if (step === 3) {
                runStatutoryAudit(); 
            }
            
            document.getElementById(`step${currentStep}`).style.display = 'none';
            document.getElementById(`step${step}`).style.display = 'block';
            
            // Update progress indicator
            updateProgressIndicator(step);
            
            currentStep = step;
            if (step === 4) updateTotal(); // Refresh total on payment step
        }
        
        function prevStep(step) {
            document.getElementById(`step${currentStep}`).style.display = 'none';
            document.getElementById(`step${step}`).style.display = 'block';
            
            // Update progress indicator
            updateProgressIndicator(step);
            
            currentStep = step;
        }

        function runStatutoryAudit() {
            const data = collectEntityData();
            const report = document.getElementById('auditReport');
            const badge = document.getElementById('auditStatusBadge');
            let issues = [];
            let score = 100;

            // 1. P.O. Box Check (Â§ 605.0113)
            if (data.principal_address.toLowerCase().includes('p.o. box') || data.principal_address.toLowerCase().includes('po box')) {
                issues.push({ 
                    type: 'error', 
                    title: 'Statutory Address Violation', 
                    msg: 'Florida Statute Â§ 605.0113 prohibits using a P.O. Box as a Principal Place of Business. A physical street address is mandatory.',
                    field: 'Address'
                });
                score -= 40;
            }

            // 2. Name Availability simulation
            const takenNames = ['Disney LLC', 'Publix LLC', 'Charter Legacy LLC'];
            if (takenNames.some(tn => data.llc_name.toLowerCase().includes(tn.toLowerCase()))) {
                issues.push({
                    type: 'warning',
                    title: 'Potential Name Conflict',
                    msg: 'This name appears similar to existing Florida entities. This may lead to rejection by the Division of Corporations.',
                    field: 'Identity'
                });
                score -= 20;
            }

            // 3. Simple Spell Check (Purpose)
            const purpose = data.statutory_purpose.toLowerCase();
            // (Simple demonstration of community usage nudge)
            if (purpose.length > 0 && !purpose.includes('legal') && !purpose.includes('lawful')) {
                issues.push({
                    type: 'warning',
                    title: 'Common Filing Pattern',
                    msg: '80% of our customers include the phrase "any and all lawful business" to maximize their statutory flexibility.',
                    field: 'Purpose'
                });
                score -= 5;
            }

            // Render Audit Report
            let html = '';
            
            // Identity Section
            html += `
                <div class="review-section">
                    <div class="review-header">
                        <span class="review-title">Sovereign Identity</span>
                        <button class="btn-edit-inline" onclick="prevStep(1)">Edit</button>
                    </div>
                    <div class="review-data-row">
                        <span class="review-label">LLC Name</span>
                        <span class="review-value">${data.llc_name}</span>
                    </div>
                    <div class="review-data-row">
                        <span class="review-label">Purpose</span>
                        <span class="review-value" style="font-size: 0.8rem; font-weight: 500;">${data.statutory_purpose || 'N/A'}</span>
                    </div>
                </div>
            `;

            // Presence Section
            html += `
                <div class="review-section">
                    <div class="review-header">
                        <span class="review-title">Statutory Presence</span>
                        <button class="btn-edit-inline" onclick="prevStep(2)">Edit</button>
                    </div>
                    <div class="review-data-row">
                        <span class="review-label">Principal</span>
                        <span class="review-value">${data.principal_address}</span>
                    </div>
                    <div class="review-data-row">
                        <span class="review-label">Managers</span>
                        <span class="review-value">${data.managers.length} Partner(s) Listed</span>
                    </div>
                </div>
            `;

            // Display Issues
            if (issues.length > 0) {
                html += '<div style="margin-top: 20px;"><span class="review-title" style="color: var(--gold-leaf);">Statutory Findings</span></div>';
                issues.forEach(issue => {
                    html += `
                        <div class="review-section" style="border-left: 4px solid ${issue.type === 'error' ? 'var(--statutory-red)' : 'var(--gold-leaf)'}; margin-top: 10px;">
                            <div style="font-weight: 800; font-size: 0.8rem; text-transform: uppercase; color: ${issue.type === 'error' ? 'var(--statutory-red)' : 'var(--gold-leaf)'}; mb: 4px;">${issue.title}</div>
                            <div style="font-size: 0.85rem; opacity: 0.8; line-height: 1.4;">${issue.msg}</div>
                        </div>
                    `;
                });
            }

            report.innerHTML = html;

            // Update Badge
            if (score >= 90) {
                badge.className = 'audit-badge audit-ready';
                badge.textContent = 'Ready for Filing';
            } else if (score >= 60) {
                badge.className = 'audit-badge audit-warning';
                badge.textContent = 'Yellow Flag: Review Advised';
            } else {
                badge.className = 'audit-badge audit-error';
                badge.textContent = 'Statutory Block: Action Required';
            }

            return true; 
        }
        
        function updateProgressIndicator(step) {
            const steps = document.querySelectorAll('.progress-step');
            
            steps.forEach((stepEl, index) => {
                const stepNumber = index + 1;
                
                // Remove all states
                stepEl.classList.remove('active', 'completed');
                
                // Add appropriate state
                if (stepNumber < step) {
                    stepEl.classList.add('completed');
                } else if (stepNumber === step) {
                    stepEl.classList.add('active');
                }
            });
        }

        // Advanced Options Toggling
        function toggleAdvanced(btn) {
            const accordion = btn.closest('.advanced-options-accordion');
            accordion.classList.toggle('open');
        }

        let managerCount = 1;

        function addManagerSlot() {
            if (managerCount >= 6) {
                alert('Sunbiz allows a maximum of 6 managers for online filing.');
                return;
            }
            
            managerCount++;
            const container = document.getElementById('managersList');
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) emptyState.remove();
            
            const slotHtml = `
                <div class="manager-slot" id="mgr-slot-${managerCount}" style="padding: 15px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5 style="margin: 0;">Partner / Manager #${managerCount}</h5>
                        <button type="button" class="btn-dismiss" onclick="removeManagerSlot(${managerCount})" style="color: var(--accent-red);">Ã—</button>
                    </div>
                    <div class="input-row">
                        <div class="form-field">
                            <label>First Name</label>
                            <input type="text" name="mgr${managerCount}_first" placeholder="Jane" onchange="collectEntityData()" onblur="this.value = normalizeName(this.value)">
                        </div>
                        <div class="form-field">
                            <label>Last Name</label>
                            <input type="text" name="mgr${managerCount}_last" placeholder="Smith" onchange="collectEntityData()" onblur="this.value = normalizeName(this.value)">
                        </div>
                    </div>
                    <div class="form-field">
                        <label>Street Address</label>
                        <input type="text" name="mgr${managerCount}_addr" placeholder="456 Pine Rd" onchange="collectEntityData()">
                    </div>
                </div>
            `;
            
            const button = container.querySelector('.btn-outline-gold');
            const newSlot = document.createElement('div');
            newSlot.innerHTML = slotHtml;
            container.insertBefore(newSlot.firstElementChild, button);
        }

        function removeManagerSlot(id) {
            document.getElementById(`mgr-slot-${id}`).remove();
            managerCount--;
            if (managerCount === 1) {
                document.getElementById('managersList').innerHTML = `
                    <p class="empty-state">No other partners added yet. You've already listed the first person (above).</p>
                    <button type="button" class="btn-outline-gold" onclick="addManagerSlot()">
                        <svg viewBox="0 0 24 24" fill="none" width="16" height="16">
                            <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2"/><line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        Add Another Partner/Leader
                    </button>
                `;
            }
        }

        // Collect entity data for OA pre-population
        function collectEntityData() {
            const llcName = document.getElementById('llcName').value;
            const address = document.getElementById('address').value;
            const city = document.getElementById('city').value;
            const zip = document.getElementById('zip').value;
            
            // Collect all managers
            const managers = [];
            
            // First Manager (Mandatory)
            managers.push({
                title: 'MGR',
                firstName: document.getElementById('mgr1_first').value || 'Owner',
                lastName: document.getElementById('mgr1_last').value || 'Name',
                address: document.getElementById('mgr1_addr').value || address,
                city: city || 'Florida City',
                state: 'FL',
                zip: zip || '12345'
            });
            
            // Additional Managers
            for (let i = 2; i <= 6; i++) {
                const fName = document.querySelector(`input[name="mgr${i}_first"]`);
                if (fName && fName.value) {
                    managers.push({
                        title: 'MGR',
                        firstName: fName.value,
                        lastName: document.querySelector(`input[name="mgr${i}_last"]`).value,
                        address: document.querySelector(`input[name="mgr${i}_addr"]`).value,
                        city: city,
                        state: 'FL',
                        zip: zip
                    });
                }
            }
            
            return {
                entity_id: currentEntityId,
                llc_name: llcName,
                formation_date: new Date().toISOString().split('T')[0],
                principal_address: `${address}, ${city}, FL ${zip}`,
                effective_date: document.getElementById('effectiveDate').value,
                statutory_purpose: document.getElementById('purpose').value,
                managers: managers
            };
        }

        // Draft OA Now - Redirect to OA Builder
        function draftOANow() {
            const entityData = collectEntityData();
            
            // Save entity data for OA pre-population
            localStorage.setItem('pending_oa_entity', JSON.stringify(entityData));
            
            console.log('Redirecting to OA Builder with entity data:', entityData);
            
            // Redirect to OA Builder
            window.location.href = `/app/oa-builder.html?entity_id=${entityData.entity_id}&source=formation`;
        }

        // Skip OA - Go to Dashboard
        function skipOAForNow() {
            // Clear any pending OA data
            localStorage.removeItem('pending_oa_entity');
            
            console.log('User skipped OA, redirecting to dashboard');
            
            // Redirect to dashboard with formation_complete flag
            window.location.href = '/app/obsidian-zenith.html?formation_complete=true';
        }

        
        function normalizeName(val) {
            if (!val) return "";
            return val.trim()
                .toLowerCase()
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // Validation Functions
        function validateLLCName(input) {
            const value = input.value.trim();
            const field = input.closest('.form-field');
            const hint = field.querySelector('.input-hint');
            
            // Check if contains LLC or Limited Liability Company
            const hasLLC = value.toLowerCase().includes('llc') || 
                          value.toLowerCase().includes('limited liability company');
            
            if (value.length === 0) {
                field.classList.remove('valid', 'error');
                hint.textContent = 'Must include "LLC" or "Limited Liability Company"';
                hint.className = 'input-hint';
            } else if (hasLLC) {
                field.classList.remove('error');
                field.classList.add('valid');
                hint.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg> Valid LLC name';
                hint.className = 'input-hint hint-success';
            } else {
                field.classList.remove('valid');
                field.classList.add('error');
                hint.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg> Must include "LLC" or "Limited Liability Company"';
                hint.className = 'input-hint hint-error';
            }
        }

        function updateCharCounter(textarea) {
            const maxLength = textarea.getAttribute('maxlength') || 240;
            const currentLength = textarea.value.length;
            const counterId = textarea.id === 'purpose' ? 'purposeCounter' : 'provisionCounter';
            const counter = document.getElementById(counterId);
            
            if (counter) {
                counter.textContent = `${currentLength} / ${maxLength}`;
                
                // Update counter color based on usage
                counter.classList.remove('warning', 'error');
                if (currentLength > maxLength * 0.9) {
                    counter.classList.add('error');
                } else if (currentLength > maxLength * 0.75) {
                    counter.classList.add('warning');
                }
            }
        }

        document.getElementById('intentForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            // Generate mock entity ID
            currentEntityId = 'ent-' + Date.now();
            
            // In production, this would hit Stripe and then Supabase
            const total = document.getElementById('finalTotal').textContent;
            
            console.log(`Formation submitted for ${document.getElementById('llcName').value}`);
            console.log(`Entity ID: ${currentEntityId}`);
            
            // Show Step 5 (Success / OA Prompt)
            nextStep(5);
        });
    </script>
</body>
</html>

